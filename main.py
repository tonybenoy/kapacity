import asyncio
import csv
import logging
import os
from typing import Dict, List

import typer
from httpx import AsyncClient, BasicAuth

from constants import BASE_URL, PASSWORD, USERNAME

logging.basicConfig(level=logging.INFO)
app = typer.Typer()


async def get_data(filename: str) -> Dict[str, List[Dict]]:
    url = BASE_URL + "/json"
    # a = {
    #     "data": [
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 53.39133462270101,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:10:00+00:00",
    #             "Set point °C": 36.5,
    #             "Supply temp °C": 36.14833329518636,
    #             "Outdoor temperature °C": 4.183999862670898,
    #             "Power-sum kW": "error",  # 10.83403328259786,
    #             "heat_value": 38.944040003811374,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.033444816053511704,
    #             "dhw_tank_temp": 53.0,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:00:00+00:00",
    #             "Set point °C": 36.85384602371267,
    #             "Supply temp °C": 41.79999923706055,
    #             "Outdoor temperature °C": 3.933444879525481,
    #             "Power-sum kW": 1.2152508432450502,
    #             "heat_value": 93.92253826988626,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.0,
    #             "dhw_tank_temp": 53.418730337085535,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:05:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 41.62006667784624,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 20.57739144264655,
    #             "heat_value": 81.2529869184435,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.2040133779264215,
    #             "dhw_tank_temp": 53.43913029189094,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:50:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 32.055851990562616,
    #             "Outdoor temperature °C": 3.7478260890297266,
    #             "Power-sum kW": 13.648896042319842,
    #             "heat_value": 7.644313829254279,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.6424994468689,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:40:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 32.34392907278878,
    #             "Outdoor temperature °C": 3.7914285319192067,
    #             "Power-sum kW": 0.22085714212485721,
    #             "heat_value": 67.7327314146072,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.76269410681848,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:05:00+00:00",
    #             "Set point °C": 35.900001525878906,
    #             "Supply temp °C": 32.08704530389815,
    #             "Outdoor temperature °C": 4.050259019426731,
    #             "Power-sum kW": 0.21751295084162697,
    #             "heat_value": 67.81892384575602,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": -5351.717145515211,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:05:00+00:00",
    #             "Set point °C": "error",
    #             "Supply temp °C": 34.545454795914466,
    #             "Outdoor temperature °C": 4.235353479481707,
    #             "Power-sum kW": 10.687525334984365,
    #             "heat_value": 43.79768744250489,
    #         },
    #         {
    #             "device_id": "11111",
    #             "dhw_tank_temp": 53.02592624959721,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:55:00+00:00",
    #             "Set point °C": 35.79999923706055,
    #             "Supply temp °C": 32.33535419810902,
    #             "Outdoor temperature °C": 4.064646402994792,
    #             "Power-sum kW": 3.8331649639088696,
    #             "heat_value": 9.919311055704682,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 53.416443408735645,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:45:00+00:00",
    #             "Set point °C": 37.39563719218209,
    #             "Supply temp °C": 33.11644339081425,
    #             "Outdoor temperature °C": 4.091946221037999,
    #             "Power-sum kW": 10.38258384218152,
    #             "heat_value": 69.0465714202518,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:50:00+00:00",
    #             "Set point °C": 36.469565681789234,
    #             "Supply temp °C": 41.84099396415379,
    #             "Outdoor temperature °C": 4.0,
    #             "Power-sum kW": 0.2170807425835118,
    #             "heat_value": 7.492190112953923,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.70000020523518,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:05:00+00:00",
    #             "Set point °C": 38.195906098125974,
    #             "Supply temp °C": 33.886549185591136,
    #             "Outdoor temperature °C": 3.799999952316284,
    #             "Power-sum kW": 0.25830409601766463,
    #             "heat_value": 83.51707837071858,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.4904214120916,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:00:00+00:00",
    #             "Set point °C": 35.857088666309345,
    #             "Supply temp °C": 32.32413843673765,
    #             "Outdoor temperature °C": 4.028735604779474,
    #             "Power-sum kW": 0.21482758224010468,
    #             "heat_value": 4.379153866033747,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.9661016949152543,
    #             "dhw_tank_temp": 53.042033993995794,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:35:00+00:00",
    #             "Set point °C": 38.099998474121094,
    #             "Supply temp °C": 30.07457649101645,
    #             "Outdoor temperature °C": 4.076949079157942,
    #             "Power-sum kW": 25.75227123842401,
    #             "heat_value": 14.728255669540003,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.0,
    #             "dhw_tank_temp": 5366.464634134312,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:50:00+00:00",
    #             "Set point °C": 36.337373829851245,
    #             "Supply temp °C": 31.38080762612699,
    #             "Outdoor temperature °C": 4.086868604024251,
    #             "Power-sum kW": 5.337828320686263,
    #             "heat_value": 59.98221048907714,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.6666666666666667,
    #             "dhw_tank_temp": 53.84705913768095,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:55:00+00:00",
    #             "Set point °C": 36.48137283325195,
    #             "Supply temp °C": 32.07941289041557,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 16.889901773602354,
    #             "heat_value": 1.7134952869440223,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 52.96140910155021,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:35:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 33.087582556193304,
    #             "Outdoor temperature °C": 3.9201342851523586,
    #             "Power-sum kW": 20.526677598889243,
    #             "heat_value": 87.1183901278276,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.68,
    #             "dhw_tank_temp": 53.47499990463257,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:20:00+00:00",
    #             "Set point °C": 35.400001525878906,
    #             "Supply temp °C": 40.400001525878906,
    #             "Outdoor temperature °C": 4.351500141620636,
    #             "Power-sum kW": 19.53229975938797,
    #             "heat_value": 4.929870377521239,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 52.56319985961914,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:45:00+00:00",
    #             "Set point °C": 37.27200024414063,
    #             "Supply temp °C": 39.99199990844726,
    #             "Outdoor temperature °C": 4.168799839019775,
    #             "Power-sum kW": 20.49023954772949,
    #             "heat_value": 22.587270408619563,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 52.21610759248669,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:50:00+00:00",
    #             "Set point °C": 36.36912737596755,
    #             "Supply temp °C": 43.77583853190377,
    #             "Outdoor temperature °C": 3.948657767084621,
    #             "Power-sum kW": 21.292248239453208,
    #             "heat_value": 4.742088900336916,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.599998474121094,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:25:00+00:00",
    #             "Set point °C": 37.08805024248999,
    #             "Supply temp °C": 31.894339219579155,
    #             "Outdoor temperature °C": 4.115723160077941,
    #             "Power-sum kW": 0.22232704408138804,
    #             "heat_value": 88.02507397033766,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.44865783588998,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:15:00+00:00",
    #             "Set point °C": 38.115772900165325,
    #             "Supply temp °C": 41.79832198635844,
    #             "Outdoor temperature °C": 3.851342307641202,
    #             "Power-sum kW": 0.21567113742532346,
    #             "heat_value": 89.68750842673842,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 53.28044646279106,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:55:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 31.973742916597335,
    #             "Outdoor temperature °C": 3.7664804312103954,
    #             "Power-sum kW": 21.7000561293277,
    #             "heat_value": 1.320441136504269,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.599998474121094,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:45:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 32.15175845275572,
    #             "Outdoor temperature °C": 3.7889446864775076,
    #             "Power-sum kW": 0.23663316539783574,
    #             "heat_value": 56.22362639380957,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 52.5081910012932,
    #             "dhw_start_temp": 51000.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:40:00+00:00",
    #             "Set point °C": 38.20000076293945,
    #             "Supply temp °C": 43.79999923706055,
    #             "Outdoor temperature °C": 4.019795202964809,
    #             "Power-sum kW": 0.509692824639558,
    #             "heat_value": 1.8261041368928588,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 53.04448092661574,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:30:00+00:00",
    #             "Set point °C": 36.38394734054106,
    #             "Supply temp °C": 40.904013451923895,
    #             "Outdoor temperature °C": 4.04046818883124,
    #             "Power-sum kW": 11.592006619558685,
    #             "heat_value": 43.30981181176744,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.751677852348993,
    #             "dhw_tank_temp": 52.74932965016205,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:25:00+00:00",
    #             "Set point °C": 36.48758408207221,
    #             "Supply temp °C": 39.745301931496435,
    #             "Outdoor temperature °C": 4.024161050783708,
    #             "Power-sum kW": 25.971879175045345,
    #             "heat_value": 65.9524664634077,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 52.577851161060714,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:35:00+00:00",
    #             "Set point °C": 38.013757923305434,
    #             "Supply temp °C": 43.79999923706055,
    #             "Outdoor temperature °C": 4.076174423998634,
    #             "Power-sum kW": 0.2199999988079071,
    #             "heat_value": 10.611384114688672,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 52.40270249908035,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:50:00+00:00",
    #             "Set point °C": 35.90033816002511,
    #             "Supply temp °C": 34.03108095478367,
    #             "Outdoor temperature °C": 4.083783703881341,
    #             "Power-sum kW": 21.468209144231434,
    #             "heat_value": 65.85315931516112,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 52.53716159511257,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:30:00+00:00",
    #             "Set point °C": 36.8604730786504,
    #             "Supply temp °C": 43.79999923706055,
    #             "Outdoor temperature °C": 4.074999928474426,
    #             "Power-sum kW": 0.22168918890324799,
    #             "heat_value": 48.11565903612534,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.70000076293945,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:35:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 33.15999998935433,
    #             "Outdoor temperature °C": 3.7893022880997766,
    #             "Power-sum kW": 0.2199069755021916,
    #             "heat_value": 45.33131232737997,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.0,
    #             "dhw_tank_temp": 53.613704855672,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T21:00:00+00:00",
    #             "Set point °C": 36.338578800259505,
    #             "Supply temp °C": 31.415228325703424,
    #             "Outdoor temperature °C": 3.7121827771821,
    #             "Power-sum kW": 5.588578802680001,
    #             "heat_value": 62.511666324313545,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.70000076293945,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:15:00+00:00",
    #             "Set point °C": 35.91162925542787,
    #             "Supply temp °C": 32.87873717399927,
    #             "Outdoor temperature °C": 4.067774021744332,
    #             "Power-sum kW": 0.22262458493345202,
    #             "heat_value": 85.1394023244522,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 53.29999923706055,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:15:00+00:00",
    #             "Set point °C": 36.5,
    #             "Supply temp °C": 37.60401319420856,
    #             "Outdoor temperature °C": 4.114381161820529,
    #             "Power-sum kW": 11.258695653449731,
    #             "heat_value": 31.7959646297602,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.6094276094276094,
    #             "dhw_tank_temp": 53.07205380012692,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:40:00+00:00",
    #             "Set point °C": 38.099998474121094,
    #             "Supply temp °C": 30.8521886754919,
    #             "Outdoor temperature °C": 4.075084103478326,
    #             "Power-sum kW": 23.553973358488243,
    #             "heat_value": 25.732054089619083,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 52.61091575455978,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:40:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 33.0,
    #             "Outdoor temperature °C": 3.9685589819495855,
    #             "Power-sum kW": 21.367511266183644,
    #             "heat_value": 47.42954883933389,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.0,
    #             "dhw_tank_temp": 53.27510053948705,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:10:00+00:00",
    #             "Set point °C": 35.37108520140131,
    #             "Supply temp °C": 40.33855433636401,
    #             "Outdoor temperature °C": 4.403614549751741,
    #             "Power-sum kW": 6.319397579713997,
    #             "heat_value": 95.3892866184654,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.184,
    #             "dhw_tank_temp": 52.7432001953125,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:05:00+00:00",
    #             "Set point °C": 35.20000076293945,
    #             "Supply temp °C": 40.35839981079101,
    #             "Outdoor temperature °C": 4.380000114440918,
    #             "Power-sum kW": 22.86168017578125,
    #             "heat_value": 98.84009389456904,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.4240282685512367,
    #             "dhw_tank_temp": 53.079858409221096,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:15:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 43.78869243392675,
    #             "Outdoor temperature °C": 4.108480461915896,
    #             "Power-sum kW": 14.43272091558881,
    #             "heat_value": 76.0005259570383,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": "error",
    #             "dhw_tank_temp": 52.84314683246129,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:00:00+00:00",
    #             "Set point °C": 35.20000076293945,
    #             "Supply temp °C": 39.91776624185785,
    #             "Outdoor temperature °C": 4.376142250099763,
    #             "Power-sum kW": -3124.756304261648,
    #             "heat_value": 91.22550885687572,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.81034430142107,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:25:00+00:00",
    #             "Set point °C": 36.516379060416384,
    #             "Supply temp °C": 34.01293111669606,
    #             "Outdoor temperature °C": 3.8103447947008857,
    #             "Power-sum kW": 0.39482758939266205,
    #             "heat_value": 72.40791523631512,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.9288135593220339,
    #             "dhw_tank_temp": 53.2152547674664,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:25:00+00:00",
    #             "Set point °C": 35.484745995473055,
    #             "Supply temp °C": 40.400001525878906,
    #             "Outdoor temperature °C": 4.291525543342202,
    #             "Power-sum kW": 6.730813509629945,
    #             "heat_value": 87.59741753377574,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.0604026845637584,
    #             "dhw_tank_temp": 53.52986531609657,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:00:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 39.02349003529389,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 20.051074104821122,
    #             "heat_value": 47.58339173753231,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.62799911499023,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:20:00+00:00",
    #             "Set point °C": 36.08499910990397,
    #             "Supply temp °C": 32.18166634877523,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 0.22106666604677835,
    #             "heat_value": 11.464833186850266,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.6464646464646464,
    #             "dhw_tank_temp": "error",
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:35:00+00:00",
    #             "Set point °C": 36.45993327131175,
    #             "Supply temp °C": 41.93097627684725,
    #             "Outdoor temperature °C": 4.017845100826687,
    #             "Power-sum kW": 9.438114488967742,
    #             "heat_value": 22.365087165463216,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.4597315436241611,
    #             "dhw_tank_temp": 53.470470249252834,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:15:00+00:00",
    #             "Set point °C": 35.400001525878906,
    #             "Supply temp °C": 40.38691397801342,
    #             "Outdoor temperature °C": 4.405369217763811,
    #             "Power-sum kW": 2.6386912762118664,
    #             "heat_value": 98.88778068418843,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 53.54975293540015,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:50:00+00:00",
    #             "Set point °C": 36.31527138695928,
    #             "Supply temp °C": 34.65123190668416,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 10.748128219191077,
    #             "heat_value": 57.842862336781955,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.599998474121094,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:15:00+00:00",
    #             "Set point °C": 38.09137173957631,
    #             "Supply temp °C": 34.44974573977708,
    #             "Outdoor temperature °C": 3.799999952316284,
    #             "Power-sum kW": 0.21984771446225607,
    #             "heat_value": 29.826210135611607,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.4129692832764504,
    #             "dhw_tank_temp": 52.4979522496767,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:25:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 43.85392512559077,
    #             "Outdoor temperature °C": 4.092150082767213,
    #             "Power-sum kW": 10.906245737911899,
    #             "heat_value": 97.57101331571559,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.5589225589225589,
    #             "dhw_tank_temp": 53.4922560104216,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:30:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 33.099998474121094,
    #             "Outdoor temperature °C": 3.808080791222929,
    #             "Power-sum kW": 7.294309784115765,
    #             "heat_value": 54.75400788285015,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.0568561872909699,
    #             "dhw_tank_temp": 52.9441474863518,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:10:00+00:00",
    #             "Set point °C": 38.38863002815374,
    #             "Supply temp °C": 41.79999923706055,
    #             "Outdoor temperature °C": 3.8230769084050107,
    #             "Power-sum kW": 8.21474913061662,
    #             "heat_value": 17.464564566697305,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.9090909090909091,
    #             "dhw_tank_temp": 53.79090950705788,
    #             "dhw_start_temp": "error",
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:30:00+00:00",
    #             "Set point °C": 36.38219738006592,
    #             "Supply temp °C": 34.11856019858158,
    #             "Outdoor temperature °C": 3.7992423989556054,
    #             "Power-sum kW": 6.181894158041387,
    #             "heat_value": 69.44404775045166,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.557213930348259,
    #             "dhw_tank_temp": 53.69850655930552,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:00:00+00:00",
    #             "Set point °C": 36.5,
    #             "Supply temp °C": 32.67313430558389,
    #             "Outdoor temperature °C": 4.1323381822500656,
    #             "Power-sum kW": 16.56920395087247,
    #             "heat_value": 38.4503381400546,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.43267301049563,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:00:00+00:00",
    #             "Set point °C": 37.09009869263904,
    #             "Supply temp °C": 39.44059398386738,
    #             "Outdoor temperature °C": 3.8485148732024843,
    #             "Power-sum kW": 0.2250495064671677,
    #             "heat_value": 14.212231073736136,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.599998474121094,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:20:00+00:00",
    #             "Set point °C": 36.61899927139282,
    #             "Supply temp °C": 33.3930002784729,
    #             "Outdoor temperature °C": 3.787999963760376,
    #             "Power-sum kW": 0.22530000165104866,
    #             "heat_value": 42.87678409618418,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.6363636363636362,
    #             "dhw_tank_temp": 53.05690273451886,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:20:00+00:00",
    #             "Set point °C": 36.5,
    #             "Supply temp °C": 38.77474737970115,
    #             "Outdoor temperature °C": 4.082828203837077,
    #             "Power-sum kW": 27.68949519584476,
    #             "heat_value": 74.27092703551814,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.4942528735632183,
    #             "dhw_tank_temp": 52.62183915061512,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:55:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 43.637931779883374,
    #             "Outdoor temperature °C": 3.9195402792130394,
    #             "Power-sum kW": 13.148448187729407,
    #             "heat_value": 30.006514230453796,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.01807664724497,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:55:00+00:00",
    #             "Set point °C": 36.481538743239184,
    #             "Supply temp °C": 41.8088455933791,
    #             "Outdoor temperature °C": 3.9719231036993174,
    #             "Power-sum kW": 0.2199999988079071,
    #             "heat_value": 2.9622156580876746,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.068998947143555,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:35:00+00:00",
    #             "Set point °C": 36.69250072479248,
    #             "Supply temp °C": 40.39950151443482,
    #             "Outdoor temperature °C": 4.1759998321533205,
    #             "Power-sum kW": 0.219949998781085,
    #             "heat_value": 86.67656297869438,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.1044776119402986,
    #             "dhw_tank_temp": 53.16865683313626,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": "error",
    #             "time_stamp": "2022-10-19T18:45:00+00:00",
    #             "Set point °C": 36.29999923706055,
    #             "Supply temp °C": 32.5089548879595,
    #             "Outdoor temperature °C": 4.016791028762931,
    #             "Power-sum kW": 8.210298678323404,
    #             "heat_value": 12.019835778780264,
    #         },
    #         {
    #             "device_id": "error",
    #             "units_on": 3.1843003412969284,
    #             "dhw_tank_temp": -5364.914635668029,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:55:00+00:00",
    #             "Set point °C": 36.1426615666204,
    #             "Supply temp °C": 36.93720134696049,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 22.917406440188046,
    #             "heat_value": 17.946061811809567,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.0436241610738255,
    #             "dhw_tank_temp": 52.77852407877877,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:20:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 44.119127363166555,
    #             "Outdoor temperature °C": 4.124160955416277,
    #             "Power-sum kW": 7.184161069409159,
    #             "heat_value": 50.18253183608059,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 2.0,
    #             "dhw_tank_temp": 52.82300060272217,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:05:00+00:00",
    #             "Set point °C": 38.062999877929684,
    #             "Supply temp °C": 41.79999923706055,
    #             "Outdoor temperature °C": 3.857500034570694,
    #             "Power-sum kW": 21.235749931335448,
    #             "heat_value": 66.966556424225,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.67224047096278,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T20:20:00+00:00",
    #             "Set point °C": 36.79732410086437,
    #             "Supply temp °C": 40.125418315364364,
    #             "Outdoor temperature °C": 3.824414702960879,
    #             "Power-sum kW": 0.2159531738945473,
    #             "heat_value": 68.30361218296345,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.129742744641426,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:30:00+00:00",
    #             "Set point °C": 35.50512822469076,
    #             "Supply temp °C": 40.38769355187049,
    #             "Outdoor temperature °C": 4.192307535807291,
    #             "Power-sum kW": 0.2175897411046884,
    #             "heat_value": 72.0623212850106,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.385135135135135,
    #             "dhw_tank_temp": 52.38885162972115,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:45:00+00:00",
    #             "Set point °C": 37.51418937219156,
    #             "Supply temp °C": 43.79999923706055,
    #             "Outdoor temperature °C": 3.9942567622339404,
    #             "Power-sum kW": 15.695405411559182,
    #             "heat_value": 63.74234793125226,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.0,
    #             "dhw_tank_temp": 53.5702009490042,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:25:00+00:00",
    #             "Set point °C": 36.428283710672396,
    #             "Supply temp °C": 33.13383763245862,
    #             "Outdoor temperature °C": 3.7752525011698403,
    #             "Power-sum kW": 0.22742424355913896,
    #             "heat_value": 80.08855045156015,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.4013377926421405,
    #             "dhw_tank_temp": "error",
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T15:40:00+00:00",
    #             "Set point °C": -3762.040087849799,
    #             "Supply temp °C": 40.30802617663125,
    #             "Outdoor temperature °C": 4.144481467562774,
    #             "Power-sum kW": 4.840668825052654,
    #             "heat_value": 87.03120527029081,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.6950354609929077,
    #             "dhw_tank_temp": 53.20000076293945,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:40:00+00:00",
    #             "Set point °C": 36.44751853131233,
    #             "Supply temp °C": 41.99503553674576,
    #             "Outdoor temperature °C": 4.0304964248170245,
    #             "Power-sum kW": 17.1539009310675,
    #             "heat_value": 27.991654990486637,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.9470198675496688,
    #             "dhw_tank_temp": 53.76589359510813,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T18:10:00+00:00",
    #             "Set point °C": 38.36920611905736,
    #             "Supply temp °C": 34.899337831711925,
    #             "Outdoor temperature °C": 3.791059563491518,
    #             "Power-sum kW": 9.207019795003712,
    #             "heat_value": 28.375338291602127,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.9036144578313253,
    #             "dhw_tank_temp": 53.0,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T19:45:00+00:00",
    #             "Set point °C": 36.40963993302311,
    #             "Supply temp °C": 41.900001525878906,
    #             "Outdoor temperature °C": 4.028915635074478,
    #             "Power-sum kW": 5.816867400364703,
    #             "heat_value": 62.19546244936299,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 1.625,
    #             "dhw_tank_temp": 53.46171894669533,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:30:00+00:00",
    #             "Set point °C": 38.099998474121094,
    #             "Supply temp °C": 31.127343744039536,
    #             "Outdoor temperature °C": 4.065624937415123,
    #             "Power-sum kW": 21.0139067620039,
    #             "heat_value": 9.02899516246669,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 0.9795918367346939,
    #             "dhw_tank_temp": 53.808163872543645,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T16:10:00+00:00",
    #             "Set point °C": 35.900001525878906,
    #             "Supply temp °C": 33.693060832120935,
    #             "Outdoor temperature °C": 4.071020340432926,
    #             "Power-sum kW": 10.80089772258486,
    #             "heat_value": 31.547777259249767,
    #         },
    #         {
    #             "device_id": "11111",
    #             "units_on": 3.0,
    #             "dhw_tank_temp": 53.37868956268811,
    #             "dhw_start_temp": 510.0,
    #             "dhw_stop_temp": 550.0,
    #             "time_stamp": "2022-10-19T17:10:00+00:00",
    #             "Set point °C": 36.20000076293945,
    #             "Supply temp °C": 43.11147542859687,
    #             "Outdoor temperature °C": 4.099999904632568,
    #             "Power-sum kW": 21.81467212614466,
    #             "heat_value": 18.66274511509761,
    #         },
    #     ]
    # }
    # return a
    async with AsyncClient(auth=BasicAuth(USERNAME, PASSWORD)) as client:
        response = await client.get(url, params={"filename": filename})
        if response.status_code == 200:
            return response.json()
        else:
            logging.error(f"Error: {response.status_code}")
            return {}


def clean_data(data: List[Dict]) -> List[Dict]:
    clean_data_list = []
    for row in data:
        cleaned_row = {
            "time_stamp": row.get("time_stamp", None),
            "supply_temp": row["Supply temp °C"]
            if isinstance(row.get("Supply temp °C", None), float)
            else None,
            "outdoor_temp": row["Outdoor temperature °C"]
            if isinstance(row.get("Outdoor temperature °C", None), float)
            else None,
            "power_kw": row["Power-sum kW"]
            if isinstance(row.get("Power-sum kW", None), float)
            else None,
        }
        if validate_data(cleaned_row):
            clean_data_list.append(cleaned_row)
    return clean_data_list


def validate_data(dataDict):
    if all(dataDict.values()):
        return True
    else:
        logging.error(f"Error (Missing value): {dataDict}")
        return False


def write_to_csv(data: List[Dict], filename: str, path: str) -> None:
    if not os.path.exists(path):
        os.mkdir(path)

    try:
        with open(f"{path}/{filename}", "w", newline="") as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=data[0].keys())
            writer.writeheader()
            writer.writerows(data)
    except IOError:
        logging.error("I/O error")


async def applet(filename: str, path: str):
    data = await get_data(filename=filename)
    cleaned_data = clean_data(data["data"])
    write_to_csv(cleaned_data, f"{filename}.csv", path=path)


@app.command()
def main(files: List[str] = typer.Argument(...), path: str = typer.Option("./out")):
    for file in files:
        if ".json" in file:
            file = file.split(".json")[0]
        asyncio.run(applet(filename=file, path=path))


if __name__ == "__main__":
    app()
